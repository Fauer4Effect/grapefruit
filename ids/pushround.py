#!/usr/bin/env python

import os
import sqlite3
import xmltodict, json
import argparse

#from flask import g

CONVO_DIR="conversations/"
STAGING_DIR="staging/"
SERVICES = {}

def parseReport(filepath):
	doc = {}
	i = 0
	db = sqlite3.connect('db.db')
	with open(filepath,'r') as fd:
		doc = xmltodict.parse(fd.read())
	doc = doc['dfxml']['configuration'][1]['fileobject']
	fname = ""
	for convo in doc:
		services = [8001,8004,8005,8009]
		dp, sp=int(convo['tcpflow']['@dstport']), int(convo['tcpflow']['@srcport'])
		svc_port=0
		if dp in services:
			svc_port=dp
		elif sp in services:
			svc_port=sp
		else:
			svc_port = min(int(convo['tcpflow']['@dstport']), int(convo['tcpflow']['@srcport']))


		db.cursor().execute("""INSERT OR IGNORE INTO services(name,port) VALUES (?, ?)""", 
		                    ("svc_{0}".format(svc_port), svc_port) )
		db.commit()

		try:
			fname = convo['filename']
		except KeyError:
			pass

		try:
			db.cursor().execute("""INSERT INTO conversations 
			                (filename, size, time, s_port, d_port, s_ip, d_ip, round, service) VALUES         
			                (?, ?, ?, ?, ?, ?, ?, (SELECT MAX(num) FROM rounds), (SELECT id FROM services WHERE port = (?)) )""", 
			                (fname, convo['filesize'], convo['tcpflow']['@startime'], 
			                convo['tcpflow']['@srcport'], convo['tcpflow']['@dstport'], convo['tcpflow']['@src_ipn'],
			                convo['tcpflow']['@dst_ipn'],svc_port) )
			db.commit()
		except sqlite3.IntegrityError:
			print "Convo Already in db"
			pass

if __name__ == '__main__':
	parser = argparse.ArgumentParser(description='Process xml files generated by tcpflow and enter them into the database')
	parser.add_argument('files', metavar='l', type=str, nargs='+', help='a list of xml files to parse')
	args = parser.parse_args()
	print args.files
	for f in args.files:
		parseReport(f)
